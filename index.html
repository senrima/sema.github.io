<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRUD Data Karyawan (GIS)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Pustaka Google Identity Services (GIS) yang BARU -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .modal-overlay, #delete-confirm-modal, #toast-notification { transition: opacity 0.3s ease, transform 0.3s ease; }
        .modal-container { transition: transform 0.3s ease; }
        .animate-spin-slow { animation: spin 1.5s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .disabled-btn { cursor: not-allowed; opacity: 0.5; }
    </style>
</head>
<body class="text-gray-800">

    <!-- Kontainer Aplikasi Utama (Awalnya tersembunyi) -->
    <div id="app-container" class="hidden">
        <div class="bg-gray-800 text-white p-3 flex justify-between items-center sticky top-0 z-40 shadow-md">
            <span id="user-info" class="text-sm font-medium"></span>
            <button id="signout_button" class="bg-red-600 text-white px-3 py-1 rounded-md text-sm hover:bg-red-700 transition-colors">Logout</button>
        </div>
        <div class="container mx-auto p-4 sm:p-6 lg:p-8">
            <header class="text-center mb-8">
                <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">Manajemen Data Karyawan</h1>
                <p class="text-md text-gray-600 mt-2">Buat, Baca, Perbarui, dan Hapus data secara live.</p>
            </header>
            <div class="mb-4 flex flex-col sm:flex-row justify-between items-center gap-4">
                <div class="relative w-full sm:max-w-xs">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg></div>
                    <input type="text" id="search-input" placeholder="Cari data apa saja..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="flex items-center space-x-2">
                    <button id="refresh-btn" class="bg-gray-600 text-white px-4 py-2 rounded-lg shadow hover:bg-gray-700 transition flex items-center space-x-2"><svg id="refresh-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h5M20 20v-5h-5M4 4l1.5 1.5A9 9 0 0120.5 15M20 20l-1.5-1.5A9 9 0 003.5 9" /></svg><span>Segarkan</span></button>
                    <button id="add-data-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition">+ Tambah Data</button>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-md overflow-x-auto">
                <div id="table-container"></div>
                <div id="pagination-controls" class="px-6 py-4 border-t border-gray-200 flex flex-col sm:flex-row justify-between items-center gap-4">
                    <span id="page-info" class="text-sm text-gray-700"></span>
                    <div class="flex items-center space-x-2">
                        <button id="prev-btn" class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 transition">Sebelumnya</button>
                        <button id="next-btn" class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 transition">Berikutnya</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Kontainer Login Keren -->
    <div id="login-container" class="fixed inset-0 z-50 flex items-center justify-center bg-gray-100 p-4">
        <div class="w-full max-w-4xl mx-auto bg-white rounded-2xl shadow-2xl flex overflow-hidden">
            <div class="hidden md:flex w-1/2 bg-gradient-to-br from-blue-600 to-indigo-700 p-12 flex-col justify-center items-center text-white">
                <svg class="w-32 h-32" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" /></svg>
                <h2 class="mt-6 text-2xl font-bold text-center">Manajemen Data Terpusat</h2>
                <p class="mt-2 text-indigo-200 text-center text-sm">Akses dan kelola semua data Anda dengan aman dan efisien dari satu tempat.</p>
            </div>
            <div class="w-full md:w-1/2 p-8 md:p-12 flex flex-col justify-center">
                <h1 class="text-3xl font-bold text-gray-800">Selamat Datang</h1>
                <p class="text-gray-600 mt-2 mb-8">Harap login dengan akun Google Anda untuk melanjutkan.</p>
                <div class="flex justify-center">
                    <div id="g_id_onload" data-client_id="MASUKKAN_CLIENT_ID_ANDA_DI_SINI" data-callback="handleCredentialResponse" data-auto_prompt="false"></div>
                    <div class="g_id_signin" data-type="standard" data-theme="outline" data-text="sign_in_with" data-shape="rectangular" data-logo_alignment="left"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Form CRUD Keren -->
    <div id="crud-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 modal-overlay opacity-0 pointer-events-none">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl modal-container transform scale-95">
            <div class="p-6 border-b">
                <h3 id="modal-title" class="text-xl font-semibold text-gray-900"></h3>
            </div>
            <form id="crud-form" class="p-6">
                <input type="hidden" id="row-index-input">
                <div id="form-inputs" class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-5"></div>
                <div class="mt-8 pt-6 border-t flex justify-end space-x-3">
                    <button type="button" id="cancel-btn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300 transition">Batal</button>
                    <button type="submit" id="save-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">Simpan</button>
                    <button type="submit" id="update-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition hidden">Perbarui</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Konfirmasi Hapus -->
    <div id="delete-confirm-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 opacity-0 pointer-events-none"><div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6"><h3 class="text-xl font-bold mb-4">Konfirmasi Penghapusan</h3><p id="delete-confirm-text" class="text-gray-700 mb-6"></p><div class="flex justify-end space-x-3"><button type="button" id="delete-cancel-btn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300 transition">Batal</button><button type="button" id="delete-confirm-btn" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition">Hapus</button></div></div></div>
    <!-- Notifikasi Toast -->
    <div id="toast-notification" class="fixed bottom-5 right-5 flex items-center text-white px-6 py-4 rounded-lg shadow-lg opacity-0 transform translate-y-5 pointer-events-none"><span id="toast-message"></span></div>

    <script>
        // --- KONFIGURASI PENTING ---
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxl8oXGcIJ-M8ln41pV5noR1CtDwfb2bM3mFAB2_HYMKmS_mWHGeMYmBIQrX5lVr1gO/exec";

        // --- ELEMEN UI ---
        const loginContainer = document.getElementById('login-container');
        const appContainer = document.getElementById('app-container');
        const signoutButton = document.getElementById('signout_button');
        const userInfo = document.getElementById('user-info');
        const tableContainer = document.getElementById('table-container');
        const refreshBtn = document.getElementById('refresh-btn');
        const refreshIcon = document.getElementById('refresh-icon');
        const searchInput = document.getElementById('search-input');
        const paginationControls = document.getElementById('pagination-controls');
        const pageInfo = document.getElementById('page-info');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const modal = document.getElementById('crud-modal');
        const modalTitle = document.getElementById('modal-title');
        const crudForm = document.getElementById('crud-form');
        const formInputsContainer = document.getElementById('form-inputs');
        const rowIndexInput = document.getElementById('row-index-input');
        const saveBtn = document.getElementById('save-btn');
        const updateBtn = document.getElementById('update-btn');
        const deleteConfirmModal = document.getElementById('delete-confirm-modal');
        const deleteConfirmText = document.getElementById('delete-confirm-text');
        const deleteConfirmBtn = document.getElementById('delete-confirm-btn');
        const deleteCancelBtn = document.getElementById('delete-cancel-btn');
        const toast = document.getElementById('toast-notification');
        const toastMessage = document.getElementById('toast-message');

        // --- STATE APLIKASI ---
        let headers = [], allBodyRows = [], filteredBodyRows = [], currentPage = 1, rowToDelete = null, toastTimeout;
        const rowsPerPage = 10;
        let googleAccessToken = null; 
        let tokenClient;

        // --- LOGIKA GOOGLE SIGN-IN (GIS BARU) ---
        window.onload = function () {
            const client_id = document.getElementById('g_id_onload').dataset.clientId;
            if (!client_id || client_id === "711412452019-7seherqo3gjnc6tujqji4dd4lufvv46p.apps.googleusercontent.com") {
                console.error("Client ID belum diisi. Harap masukkan Client ID Anda di dalam HTML.");
                alert("Konfigurasi Error: Client ID belum diisi.");
                return;
            }
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: client_id,
                scope: 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/userinfo.email',
                callback: (tokenResponse) => {
                    if (tokenResponse && tokenResponse.access_token) {
                        googleAccessToken = tokenResponse.access_token;
                        loginContainer.classList.add('hidden');
                        appContainer.classList.remove('hidden');
                        fetchData();
                    }
                },
            });
        };
        
        function handleCredentialResponse(response) {
            if (response.credential) {
                tokenClient.requestAccessToken();
            }
        }

        // --- LOGIKA APLIKASI CRUD ---
        async function callAppsScript(payload) {
            if (!googleAccessToken) throw new Error("Sesi tidak valid. Harap login kembali.");
            const res = await fetch(WEB_APP_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${googleAccessToken}`},
                body: JSON.stringify(payload)
            });
            if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
            return res.json();
        }

        function fetchData() {
            setRefreshButtonState(true);
            tableContainer.innerHTML = `<p class="p-8 text-center text-gray-500">Memuat data...</p>`;
            paginationControls.classList.add('hidden');
            callAppsScript({ action: 'read' }).then(res => {
                if (res.status === 'success') {
                    userInfo.textContent = `Login sebagai: ${res.user}`;
                    handleInitialData(res);
                } else throw new Error(res.message || "Gagal memuat data.");
            }).catch(displayError);
        }

        function sendPostRequest(payload) {
            toggleModal(false);
            tableContainer.innerHTML = `<p class="p-8 text-center text-blue-500">Memproses permintaan...</p>`;
            let successMessage = '';
            if (payload.action === 'create') successMessage = 'Data berhasil ditambahkan!';
            else if (payload.action === 'update') successMessage = 'Data berhasil diubah!';
            else if (payload.action === 'delete') successMessage = 'Data berhasil dihapus!';
            callAppsScript(payload).then(res => {
                if (res.status === 'success') {
                    if (successMessage) showToast(successMessage);
                    setTimeout(fetchData, 1000);
                } else throw new Error(res.message);
            }).catch(err => {
                showToast("Gagal mengirim data: " + err.message, 'error');
                displayError(err);
            });
        }
        
        // --- Event Listeners & Fungsi UI ---
        signoutButton.addEventListener('click', () => {
            google.accounts.id.disableAutoSelect();
            googleAccessToken = null;
            location.reload();
        });
        document.getElementById('add-data-btn').addEventListener('click', handleCreate);
        refreshBtn.addEventListener('click', fetchData);
        searchInput.addEventListener('input', handleSearch);
        prevBtn.addEventListener('click', () => { if(currentPage > 1) { currentPage--; renderTable(); } });
        nextBtn.addEventListener('click', () => { if(currentPage < Math.ceil(filteredBodyRows.length / rowsPerPage)) { currentPage++; renderTable(); } });
        document.getElementById('cancel-btn').addEventListener('click', () => toggleModal(false));
        crudForm.addEventListener('submit', handleFormSubmit);
        deleteCancelBtn.addEventListener('click', () => { rowToDelete = null; toggleDeleteModal(false); });
        deleteConfirmBtn.addEventListener('click', () => {
            if (rowToDelete) sendPostRequest({ action: 'delete', rowIndex: parseInt(rowToDelete) });
            rowToDelete = null;
            toggleDeleteModal(false);
        });
        tableContainer.addEventListener('click', (e) => {
            if (e.target.closest('.edit-btn')) handleEdit(e.target.closest('.edit-btn'));
            if (e.target.closest('.delete-btn')) handleDelete(e.target.closest('.delete-btn'));
        });
        
        function handleInitialData(response) {
            setRefreshButtonState(false);
            const dataArray = response.data;
            if (!dataArray || dataArray.length === 0) { headers = []; allBodyRows = []; } 
            else { headers = dataArray[0]; allBodyRows = dataArray.slice(1); }
            filteredBodyRows = allBodyRows;
            currentPage = 1;
            renderTable();
        };
        function renderTable() {
            if (filteredBodyRows.length === 0) {
                tableContainer.innerHTML = '<p class="p-8 text-center text-gray-500">Tidak ada data.</p>';
                paginationControls.classList.add('hidden');
                return;
            }
            paginationControls.classList.remove('hidden');
            const totalRows = filteredBodyRows.length, totalPages = Math.ceil(totalRows / rowsPerPage);
            const start = (currentPage - 1) * rowsPerPage, end = Math.min(start + rowsPerPage, totalRows);
            const pageRows = filteredBodyRows.slice(start, end);
            const table = document.createElement('table');
            table.className = 'min-w-full divide-y divide-gray-200';
            table.innerHTML = `<thead class="bg-gray-50"><tr>${headers.map(h => `<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${h}</th>`).join('')}<th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th></tr></thead>`;
            const tbody = document.createElement('tbody');
            tbody.className = 'bg-white divide-y divide-gray-200';
            pageRows.forEach((rowData) => {
                const originalIndex = allBodyRows.findIndex(r => r.every((v, i) => v === rowData[i]));
                const rowIndex = originalIndex + 2;
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50';
                tr.innerHTML = `${rowData.map(c => `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${c}</td>`).join('')}<td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium"><button class="edit-btn text-indigo-600 hover:text-indigo-900" data-row-index="${rowIndex}" data-row-data='${JSON.stringify(rowData)}'>Edit</button><button class="delete-btn text-red-600 hover:text-red-900 ml-4" data-row-index="${rowIndex}" data-row-data='${JSON.stringify(rowData)}'>Hapus</button></td>`;
                tbody.appendChild(tr);
            });
            table.appendChild(tbody);
            tableContainer.innerHTML = '';
            tableContainer.appendChild(table);
            pageInfo.textContent = `Menampilkan ${start + 1} - ${end} dari ${totalRows} data`;
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === totalPages;
            prevBtn.classList.toggle('disabled-btn', prevBtn.disabled);
            nextBtn.classList.toggle('disabled-btn', nextBtn.disabled);
        }
        function handleSearch() {
            const searchTerm = searchInput.value.toLowerCase();
            filteredBodyRows = allBodyRows.filter(row => row.some(cell => cell.toString().toLowerCase().includes(searchTerm)));
            currentPage = 1;
            renderTable();
        }
        function handleCreate() {
            crudForm.reset();
            modalTitle.innerHTML = 'Tambah Data Baru';
            rowIndexInput.value = '';
            generateFormInputs();
            saveBtn.classList.remove('hidden');
            updateBtn.classList.add('hidden');
            toggleModal(true);
        }
        function handleEdit(button) {
            const rowIndex = button.dataset.rowIndex, rowData = JSON.parse(button.dataset.rowData);
            let identifier = `Data Baris ${rowIndex}`;
            const namaIndex = headers.findIndex(h => h.toLowerCase().includes('nama'));
            const noIndex = headers.findIndex(h => h.toLowerCase().includes('no') || h.toLowerCase().includes('nomor'));
            if (namaIndex !== -1 && rowData[namaIndex]) identifier = `Data '${rowData[namaIndex]}'`;
            else if (noIndex !== -1 && rowData[noIndex]) identifier = `Data Nomor '${rowData[noIndex]}'`;
            modalTitle.innerHTML = `Edit ${identifier}`;
            rowIndexInput.value = rowIndex;
            generateFormInputs(rowData);
            saveBtn.classList.add('hidden');
            updateBtn.classList.remove('hidden');
            toggleModal(true);
        }
        function handleDelete(button) {
            const rowIndex = button.dataset.rowIndex, rowData = JSON.parse(button.dataset.rowData);
            rowToDelete = rowIndex;
            let identifier = `data pada baris ${rowIndex}`;
            const namaIndex = headers.findIndex(h => h.toLowerCase().includes('nama'));
            const noIndex = headers.findIndex(h => h.toLowerCase().includes('no') || h.toLowerCase().includes('nomor'));
            if (namaIndex !== -1 && rowData[namaIndex]) identifier = `data untuk '${rowData[namaIndex]}'`;
            else if (noIndex !== -1 && rowData[noIndex]) identifier = `data dengan nomor '${rowData[noIndex]}'`;
            else if (rowData[0]) identifier = `data '${rowData[0]}'`;
            deleteConfirmText.textContent = `Apakah Anda yakin ingin menghapus ${identifier}?`;
            toggleDeleteModal(true);
        }
        function handleFormSubmit(e) {
            e.preventDefault();
            const formData = new FormData(crudForm);
            const data = headers.map((_, i) => formData.get(`header-${i}`));
            const payload = { data: data, action: parseInt(rowIndexInput.value) ? 'update' : 'create' };
            if (payload.action === 'update') payload.rowIndex = parseInt(rowIndexInput.value);
            sendPostRequest(payload);
        }
        function getIconForHeader(header) {
            const h = header.toLowerCase();
            if (h.includes('nama')) return `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>`;
            if (h.includes('posisi') || h.includes('jabatan')) return `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>`;
            if (h.includes('no') || h.includes('nomor') || h.includes('id')) return `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14" /></svg>`;
            return `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
        }
        function generateFormInputs(values = []) {
            formInputsContainer.innerHTML = '';
            if (headers.length === 0) return;
            headers.forEach((header, index) => {
                const value = values[index] || '';
                const icon = getIconForHeader(header);
                formInputsContainer.innerHTML += `<div class="relative"><label class="block text-sm font-medium text-gray-700 mb-1">${header}</label><div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none top-7">${icon}</div><input type="text" name="header-${index}" id="header-${index}" value="${value}" required class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></div>`;
            });
        }
        function displayError(error) {
            setRefreshButtonState(false);
            tableContainer.innerHTML = `<div class="p-8 text-center text-red-600">${error.message}</div>`;
        }
        function setRefreshButtonState(isLoading) {
            refreshBtn.disabled = isLoading;
            isLoading ? refreshIcon.classList.add('animate-spin-slow') : refreshIcon.classList.remove('animate-spin-slow');
        }
        const toggleModal = (show) => {
            const container = modal.querySelector('.modal-container');
            if (show) {
                modal.classList.remove('pointer-events-none', 'opacity-0');
                container.classList.remove('scale-95');
            } else {
                modal.classList.add('pointer-events-none', 'opacity-0');
                container.classList.add('scale-95');
            }
        };
        const toggleDeleteModal = (show) => {
            if (show) deleteConfirmModal.classList.remove('pointer-events-none', 'opacity-0');
            else deleteConfirmModal.classList.add('pointer-events-none', 'opacity-0');
        };
        const showToast = (message, type = 'success') => {
            clearTimeout(toastTimeout);
            toastMessage.textContent = message;
            toast.className = toast.className.replace(/bg-\w+-\d+/, '');
            toast.classList.add(type === 'success' ? 'bg-green-500' : 'bg-red-500');
            toast.classList.remove('opacity-0', 'translate-y-5');
            toastTimeout = setTimeout(() => toast.classList.add('opacity-0', 'translate-y-5'), 3000);
        };
    </script>
</body>
</html>
